{% extends "base.html" %}
{% block title %}{% if todo %}{{ todo.title }}{% else %}Nauja užduotis{% endif %} · todo.{% endblock %}

{% load static %}


{% block content %}

<!-- ── Breadcrumb ── -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Skydelis</a></li>
    <li class="breadcrumb-item active" aria-current="page">
      {% if todo %}{{ todo.title|truncatechars:40 }}{% else %}Nauja užduotis{% endif %}
    </li>
  </ol>
</nav>

<form method="post"
      action="{% if todo %}{% url 'todo_edit' todo.pk %}{% else %}{% url 'todo_create' %}{% endif %}"
      novalidate>
{% csrf_token %}

<div class="detail-grid">

  <!-- ────────── Left column ────────── -->
  <div>
    <div class="card mb-3">
      <div class="card-body p-4">

        <!-- Title -->
        <div class="mb-4">
          <input type="text" name="title" id="id_title"
                 class="title-input form-control {% if form.title.errors %}is-invalid{% endif %}"
                 placeholder="Užduoties pavadinimas…"
                 value="{{ form.title.value|default:todo.title|default:'' }}"
                 required autocomplete="off" />
          {% if form.title.errors %}
            <div class="invalid-feedback d-block mt-1">{{ form.title.errors.0 }}</div>
          {% endif %}
        </div>

        <!-- Description -->
        <div class="mb-3">
          <label class="form-label" for="id_description">Aprašymas</label>
          <textarea name="description" id="id_description"
                    class="form-control desc-area"
                    placeholder="Pridėk papildomą informaciją, pastabas…">{{ form.description.value|default:todo.description|default:'' }}</textarea>
        </div>

      </div>
    </div>

    <!-- ── Checklist ── -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-600" style="font-family:'Syne',sans-serif;font-weight:600">
          <i class="bi bi-card-checklist me-2" style="color:var(--accent)"></i>Kontrolinis sąrašas
        </span>
        {% if todo and todo.subtasks.all %}
          <small class="text-muted">
            {{ todo.subtasks_done_count }}/{{ todo.subtasks.count }}
          </small>
        {% endif %}
      </div>
      <div class="card-body p-3">
        <div class="checklist" id="checklist-container">
          {% if todo %}
            {% for subtask in todo.subtasks.all %}
            <div class="checklist-item">
              <input type="checkbox" name="subtask_done_{{ subtask.pk }}"
                     {% if subtask.is_done %}checked{% endif %} />
              <input type="text" name="subtask_title_{{ subtask.pk }}"
                     value="{{ subtask.title }}" placeholder="Papildoma užduotis…" />
              <button type="button" class="del-sub" onclick="this.closest('.checklist-item').remove()">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
            {% endfor %}
          {% endif %}
        </div>
        <button type="button" class="btn btn-ghost btn-sm mt-2" onclick="addSubtask()">
          <i class="bi bi-plus me-1"></i>Pridėti
        </button>
      </div>
    </div>

    <!-- ── Activity ── -->
    {% if todo and todo.activity_log.all %}
    <div class="card">
      <div class="card-header">
        <span style="font-family:'Syne',sans-serif;font-weight:600;font-size:.95rem">
          <i class="bi bi-clock-history me-2" style="color:var(--accent)"></i>Veiksmų istorija
        </span>
      </div>
      <div class="card-body p-3">
        {% for log in todo.activity_log.all|slice:":8" %}
        <div class="activity-item">
          <div class="activity-dot"></div>
          <div>
            <span>{{ log.description }}</span>
            <span class="text-muted ms-2" style="font-size:.75rem">
              {{ log.created_at|timesince }} prieš
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <!-- ────────── Right sidebar ────────── -->
  <div>

    <!-- Status + Priority -->
    <div class="meta-card mb-3">

      <!-- Status -->
      <div class="meta-row">
        <span class="meta-label"><i class="bi bi-circle-half"></i>Būsena</span>
        <div>
          {% if todo %}
            {% if todo.is_completed %}
              <span class="status-pill completed"><i class="bi bi-check-circle-fill"></i>Atlikta</span>
            {% elif todo.is_overdue %}
              <span class="status-pill overdue"><i class="bi bi-exclamation-circle-fill"></i>Vėluojama</span>
            {% else %}
              <span class="status-pill pending"><i class="bi bi-hourglass-split"></i>Laukiama</span>
            {% endif %}
          {% else %}
            <span class="status-pill pending"><i class="bi bi-hourglass-split"></i>Nauja</span>
          {% endif %}
        </div>
      </div>

      <!-- Priority -->
      <div class="meta-row flex-column align-items-start gap-2">
        <span class="meta-label"><i class="bi bi-flag"></i>Prioritetas</span>
        <input type="hidden" name="priority" id="priority-hidden"
               value="{{ form.priority.value|default:todo.priority|default:'medium' }}" />
        <div class="priority-select-group">
          {% for val, label in form.priority.field.choices %}
          <button type="button" class="priority-btn {% if form.priority.value == val or todo.priority == val %}active-{{ val }}{% endif %}"
                  data-val="{{ val }}" onclick="setPriority('{{ val }}', this)">
            {{ label }}
          </button>
          {% endfor %}
        </div>
      </div>

      <!-- Due date -->
      <div class="meta-row flex-column align-items-start gap-2">
        <span class="meta-label"><i class="bi bi-calendar-event"></i>Terminas</span>
        <input type="date" name="due_date" id="id_due_date"
               class="form-control form-control-sm"
               value="{{ form.due_date.value|default:todo.due_date|date:'Y-m-d'|default:'' }}" />
      </div>

      <!-- Reminder -->
      <div class="meta-row flex-column align-items-start gap-2">
        <span class="meta-label"><i class="bi bi-bell"></i>Priminimas</span>
        <input type="datetime-local" name="reminder_at" id="id_reminder"
               class="form-control form-control-sm"
               value="{{ form.reminder_at.value|default:todo.reminder_at|date:'Y-m-d\TH:i'|default:'' }}" />
      </div>

      <!-- Assigned (optional) -->
      <div class="meta-row flex-column align-items-start gap-2">
        <span class="meta-label"><i class="bi bi-person"></i>Priskirta</span>
        <select name="assigned_to" class="form-select form-select-sm">
          <option value="">— Niekam —</option>
          {% for member in team_members %}
            <option value="{{ member.pk }}"
              {% if todo.assigned_to_id == member.pk %}selected{% endif %}>
              {{ member.get_full_name|default:member.username }}
            </option>
          {% endfor %}
        </select>
      </div>

    </div>

    <!-- Tags -->
    <div class="meta-card mb-3">
      <div class="meta-row">
        <span class="meta-label"><i class="bi bi-tags"></i>Etiketės</span>
      </div>
      <div class="p-3">
        <div class="tag-chips" id="tag-chips-container">
          {% if todo %}
            {% for tag in todo.tags.all %}
              <span class="tag-chip" style="background:{{ tag.color }}22;color:{{ tag.color }}">
                {{ tag.name }}
                <span class="remove" onclick="removeTag(this, '{{ tag.pk }}')">✕</span>
                <input type="hidden" name="tag_ids" value="{{ tag.pk }}" />
              </span>
            {% endfor %}
          {% endif %}
        </div>
        <div class="d-flex gap-2 mt-1">
          <select id="tag-select" class="form-select form-select-sm">
            <option value="">Pasirinkti etiketę…</option>
            {% for tag in available_tags %}
              <option value="{{ tag.pk }}" data-color="{{ tag.color }}">{{ tag.name }}</option>
            {% endfor %}
          </select>
          <button type="button" class="btn btn-ghost btn-sm px-3" onclick="addTag()">
            <i class="bi bi-plus"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Info (edit mode) -->
    {% if todo %}
    <div class="meta-card">
      <div class="meta-row">
        <span class="meta-label"><i class="bi bi-info-circle"></i>Sukurta</span>
        <span class="meta-value" style="font-size:.8rem;color:var(--text-muted)">
          {{ todo.created_at|date:"Y-m-d H:i" }}
        </span>
      </div>
      <div class="meta-row">
        <span class="meta-label"><i class="bi bi-pencil"></i>Keista</span>
        <span class="meta-value" style="font-size:.8rem;color:var(--text-muted)">
          {{ todo.updated_at|date:"Y-m-d H:i" }}
        </span>
      </div>
    </div>
    {% endif %}

  </div><!-- /sidebar -->
</div><!-- /grid -->

<!-- ── Action bar ── -->
<div class="action-bar">
  <button type="submit" class="btn btn-accent px-4 py-2">
    <i class="bi bi-floppy me-1"></i>
    {% if todo %}Išsaugoti pakeitimus{% else %}Sukurti užduotį{% endif %}
  </button>
  <a href="{% url 'dashboard' %}" class="btn btn-ghost px-4 py-2">Atšaukti</a>

  {% if todo %}
    <div class="ms-auto d-flex gap-2">
      <!-- Toggle complete -->
      <form method="post" action="{% url 'todo_toggle' todo.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-ghost px-3 py-2">
          {% if todo.is_completed %}
            <i class="bi bi-arrow-counterclockwise me-1"></i>Atžymėti
          {% else %}
            <i class="bi bi-check-circle me-1"></i>Pažymėti kaip atliktą
          {% endif %}
        </button>
      </form>
      <!-- Delete -->
      <form method="post" action="{% url 'todo_delete' todo.pk %}"
            onsubmit="return confirm('Tikrai ištrinti šią užduotį?')">
        {% csrf_token %}
        <button type="submit" class="btn btn-ghost px-3 py-2" style="color:var(--danger-soft)">
          <i class="bi bi-trash me-1"></i>Ištrinti
        </button>
      </form>
    </div>
  {% endif %}
</div>

</form>

{% endblock %}

{% block extra_scripts %}
<script>
/* ── Priority toggle ── */
function setPriority(val, btn) {
  document.getElementById('priority-hidden').value = val;
  document.querySelectorAll('.priority-btn').forEach(b => {
    b.className = 'priority-btn';
  });
  btn.classList.add('active-' + val);
}

/* ── Checklist ── */
let subIdx = 9000;
function addSubtask() {
  subIdx++;
  const c = document.getElementById('checklist-container');
  const div = document.createElement('div');
  div.className = 'checklist-item';
  div.innerHTML = `
    <input type="checkbox" name="subtask_done_new_${subIdx}" />
    <input type="text"     name="subtask_title_new_${subIdx}" placeholder="Papildoma užduotis…" autofocus />
    <button type="button" class="del-sub" onclick="this.closest('.checklist-item').remove()">
      <i class="bi bi-x-lg"></i>
    </button>`;
  c.appendChild(div);
  div.querySelector('input[type=text]').focus();
}

/* ── Tag management ── */
function addTag() {
  const sel = document.getElementById('tag-select');
  const opt = sel.options[sel.selectedIndex];
  if (!opt.value) return;

  // Avoid duplicates
  const existing = document.querySelectorAll('#tag-chips-container input[type=hidden]');
  for (const inp of existing) {
    if (inp.value === opt.value) { sel.selectedIndex = 0; return; }
  }

  const color = opt.dataset.color || '#888';
  const chip = document.createElement('span');
  chip.className = 'tag-chip';
  chip.style.cssText = `background:${color}22;color:${color}`;
  chip.innerHTML = `
    ${opt.text}
    <span class="remove" onclick="removeTag(this, '${opt.value}')">✕</span>
    <input type="hidden" name="tag_ids" value="${opt.value}" />`;
  document.getElementById('tag-chips-container').appendChild(chip);
  sel.selectedIndex = 0;
}

function removeTag(el, id) {
  el.closest('.tag-chip').remove();
}
</script>
{% endblock %}
